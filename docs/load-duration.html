<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.376">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>twri r-manual - 7&nbsp; Load Duration Curves</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./water-quality-statistics.html" rel="next">
<link href="./water-quality.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="css/twri.scss">
</head>
<body class="nav-sidebar floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./images/logo-drop.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">twri r-manual</span>
    </a>
  </div>
        <div class="quarto-navbar-tools">
    <a href="https://github.com/txwri/r-manual/tree/main/docs/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./water-quality.html">Water Quality</a></li><li class="breadcrumb-item"><a href="./load-duration.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Load Duration Curves</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">R Basics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Fundamentals</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_exploration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Exploration</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Hydrology</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./streamflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Streamflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stage-discharge.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Stage-Discharge Rating Curves</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./drainage-area-ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Drainage Area Ratio</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Water Quality</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./water-quality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Water Quality Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./load-duration.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Load Duration Curves</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Statistical Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./water-quality-statistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Hypothesis Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Regression Modeling</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Geospatial</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spatial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./watershed-delineation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Delineate Watersheds</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./raster-summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Extract Raster Summaries</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#data" id="toc-data" class="nav-link active" data-scroll-target="#data"><span class="header-section-number">7.1</span> Data</a>
  <ul class="collapse">
<li><a href="#water-quality" id="toc-water-quality" class="nav-link" data-scroll-target="#water-quality"><span class="header-section-number">7.1.1</span> Water Quality</a></li>
  <li><a href="#hydrology" id="toc-hydrology" class="nav-link" data-scroll-target="#hydrology"><span class="header-section-number">7.1.2</span> Hydrology</a></li>
  </ul>
</li>
  <li>
<a href="#manual-method" id="toc-manual-method" class="nav-link" data-scroll-target="#manual-method"><span class="header-section-number">7.2</span> Manual Method</a>
  <ul class="collapse">
<li><a href="#flow-duration-curve" id="toc-flow-duration-curve" class="nav-link" data-scroll-target="#flow-duration-curve"><span class="header-section-number">7.2.1</span> Flow Duration Curve</a></li>
  <li><a href="#load-duration-curve" id="toc-load-duration-curve" class="nav-link" data-scroll-target="#load-duration-curve"><span class="header-section-number">7.2.2</span> Load Duration Curve</a></li>
  </ul>
</li>
  <li><a href="#ldc-package" id="toc-ldc-package" class="nav-link" data-scroll-target="#ldc-package"><span class="header-section-number">7.3</span> ldc Package</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/txwri/r-manual/edit/main/docs/load-duration.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/txwri/r-manual/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/txwri/r-manual/blob/main/docs/load-duration.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./water-quality.html">Water Quality</a></li><li class="breadcrumb-item"><a href="./load-duration.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Load Duration Curves</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-ldc" class="quarto-section-identifier"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Load Duration Curves</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>The Load Duration Curve (LDC) is a simple method for visualizing and characterizing water quality concentrations at different flow regimes. It is supported by EPA, TCEQ and TSSWCB for Total Maximum Daily Load (TMDL) and Watershed Protection Plan (WPP) development. The LDC is an extension of a flow duration curve (FDC). The FDC is a cumulative distribution plot with observed mean daily streamflow values on the y-axis and the proportion of time or values that exceed a given flow on the x-axis. More specifically, the FDC displays the exceedance probability <span class="math inline">\(p\)</span> on the x-axis and the associated discharge, <span class="math inline">\(Q\)</span>, on the y-axis <span class="citation" data-cites="vogelFlowDurationCurves1994">(<a href="references.html#ref-vogelFlowDurationCurves1994" role="doc-biblioref">Vogel and Fennessey 1994</a>)</span>. The LDC is developed by multiplying an allowable pollutant concentration (water quality standard or screening level) by the daily streamflow volume to identify the allowable pollutant loads across flow duration intervals. Measured pollutant concentrations are added on top of the duration curve by multiplying the concentration and streamflow volume on a given day to derive an instantaneous load at a given exceedance percentile. By overlaying measured values over the duration curve, we develop some inference for what conditions pollutant concentration and loads exceed water quality thresholds.</p>
<p>The LDC approach is most appropriate in water bodies where there is some type of correlation between flow condition and concentration (typically rivers and streams where loading is tied to runoff and there are not strong accumulation processes). The LDC approach is typically not appropriate for lakes and estuaries. The LDC approach can be modified to account for tidal influences.</p>
<p><span class="citation" data-cites="u.s.environmentalprotectionagencyApproachUsingLoad2007">U.S. Environmental Protection Agency (<a href="references.html#ref-u.s.environmentalprotectionagencyApproachUsingLoad2007" role="doc-biblioref">2007</a>)</span> provides a good introduction to and discussion on the approriate uses of LDCs that are applicable for both TMDL and WPP development.</p>
<section id="data" class="level2 page-columns page-full" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="data">
<span class="header-section-number">7.1</span> Data</h2>
<p>This example uses <em>E. coli</em> bacteria concentrations collected at SWQMIS station <code>12517</code> on Tres Palacios Creek. Streamflow data comes from the co-located USGS streamgage <code>08162600</code>.</p>
<section id="water-quality" class="level3 page-columns page-full" data-number="7.1.1"><h3 data-number="7.1.1" class="anchored" data-anchor-id="water-quality">
<span class="header-section-number">7.1.1</span> Water Quality</h3>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Get the data:</strong> These examples use the <code>swqmispublicdata.txt</code> data in the <a href="https://github.com/TxWRI/r-manual/raw/main/data/tutorial.zip">example data</a></p>
</div></div><p>We will import water quality data the same way that was covered in <a href="water-quality.html" class="quarto-xref"><span>Chapter&nbsp;6</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># install.packages("janitor")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/">ggtext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.usgs.gov/water/dataRetrieval">dataRetrieval</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://andrisignorell.github.io/DescTools/">DescTools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/TxWRI/twriTemplates">twriTemplates</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_delim</a></span><span class="op">(</span><span class="st">"data/swqmispublicdata.txt"</span>,</span>
<span>                 delim <span class="op">=</span> <span class="st">"|"</span>,</span>
<span>                 <span class="co"># see awkward column names that have to be wrapped</span></span>
<span>                 <span class="co"># in between "`" (escape) marks.</span></span>
<span>                 col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols_only</a></span><span class="op">(</span></span>
<span>                   `Segment ID` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   `Station ID` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_factor.html">col_factor</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   `Station Description` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   `End Date` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_datetime.html">col_date</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"%m/%d/%Y"</span><span class="op">)</span>,</span>
<span>                   `Collecting Entity` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   `Monitoring Type` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   `Composite Category` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   `Parameter Name` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   `Parameter Code` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   `Value` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_number.html">col_number</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   `RFA/Tag ID` <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span></span>
<span>                 <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">station_id</span> <span class="op">==</span> <span class="st">"12517"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">parameter_code</span> <span class="op">==</span> <span class="st">"31699"</span><span class="op">)</span></span>
<span>  </span>
<span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 88
Columns: 11
$ segment_id          &lt;chr&gt; "1502", "1502", "1502", "1502", "1502", "1502", "1…
$ station_id          &lt;fct&gt; 12517, 12517, 12517, 12517, 12517, 12517, 12517, 1…
$ station_description &lt;chr&gt; "TRES PALACIOS CREEK AT FM 456", "TRES PALACIOS CR…
$ end_date            &lt;date&gt; 2001-03-14, 2000-12-20, 2001-06-21, 2002-01-10, 2…
$ collecting_entity   &lt;chr&gt; "TCEQ REGIONAL OFFICE", "TCEQ REGIONAL OFFICE", "T…
$ monitoring_type     &lt;chr&gt; "Routine - Monitoring not intentionally targeted t…
$ composite_category  &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
$ parameter_name      &lt;chr&gt; "E. COLI, COLILERT, IDEXX METHOD, MPN/100ML", "E. …
$ parameter_code      &lt;chr&gt; "31699", "31699", "31699", "31699", "31699", "3169…
$ value               &lt;dbl&gt; 10.0, 85.0, 183.0, 537.0, 52.0, 74.0, 24192.0, 169…
$ rfa_tag_id          &lt;chr&gt; "R194283", "R194025", "R195800", "R200079", "R2013…</code></pre>
</div>
</div>
</section><section id="hydrology" class="level3 page-columns page-full" data-number="7.1.2"><h3 data-number="7.1.2" class="anchored" data-anchor-id="hydrology">
<span class="header-section-number">7.1.2</span> Hydrology</h3>
<p>Streamflow data is obtained from the USGS NWIS using the <em>dataRetrieval</em> package. It is important to note that streamflow data might not be static. USGS might update the data at some point due to new rating curves, data quality checks, etc. We want to work off a snapshot of the data.</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>In a project workflow, this would be in a data download script that saves your downloaded data to a csv. Then in your analysis script, read the csv data. You can rerun the analysis script without having to re-download the data and possibly running into changes in the source data. Frequent repeated downloads might also cause server issues or your IP getting temporarily blocked or rate-limited by the NWIS server.</p>
</div>
</div>
</div></div><div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># This should be in a separate data download script!</span></span>
<span><span class="va">Q_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dataRetrieval/man/readNWISdv.html">readNWISdv</a></span><span class="op">(</span>siteNumbers <span class="op">=</span> <span class="st">"08162600"</span>,</span>
<span>           startDate <span class="op">=</span> <span class="st">"2000-01-01"</span>,</span>
<span>           endDate <span class="op">=</span> <span class="st">"2020-12-31"</span>,</span>
<span>           parameterCd <span class="op">=</span> <span class="st">"00060"</span>,</span>
<span>           statCd <span class="op">=</span> <span class="st">"00003"</span><span class="op">)</span></span>
<span><span class="va">Q_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dataRetrieval/man/renameNWISColumns.html">renameNWISColumns</a></span><span class="op">(</span><span class="va">Q_df</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save the data and work off the saved data</span></span>
<span><span class="co"># write_csv(Q_df, "data/streamflow_0816200.csv")</span></span>
<span><span class="co"># Q_df &lt;- read_csv("data/streamflow_0816200.csv")</span></span>
<span></span>
<span><span class="va">Q_df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 7,671
Columns: 5
$ agency_cd &lt;chr&gt; "USGS", "USGS", "USGS", "USGS", "USGS", "USGS", "USGS", "USG…
$ site_no   &lt;chr&gt; "08162600", "08162600", "08162600", "08162600", "08162600", …
$ date      &lt;date&gt; 2000-01-01, 2000-01-02, 2000-01-03, 2000-01-04, 2000-01-05,…
$ flow      &lt;dbl&gt; 0.84, 3.00, 3.40, 2.60, 1.60, 3.20, 11.00, 17.00, 22.00, 18.…
$ flow_cd   &lt;chr&gt; "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", …</code></pre>
</div>
</div>
</section></section><section id="manual-method" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="manual-method">
<span class="header-section-number">7.2</span> Manual Method</h2>
<p>First we will go through a manual method for developing the FDC and LDC. I go through this becuae it is worth understanding the specific steps for developing the FDC and LDC. the <a href="https://txwri.github.io/ldc/index.html"><em>ldc</em></a> is available to streamline these steps, but I highly reccomend understanding the fundamentals first.</p>
<section id="flow-duration-curve" class="level3" data-number="7.2.1"><h3 data-number="7.2.1" class="anchored" data-anchor-id="flow-duration-curve">
<span class="header-section-number">7.2.1</span> Flow Duration Curve</h3>
<p>The primary step in calculating the FDC is calculating the exceedance probability for each streamflow value. Without delving into statistics, there are a surprising number of ways to accomplish this. If you have lots of streamflow values, the method you chose does not matter much <span class="citation" data-cites="vogelFlowDurationCurves1994">(<a href="references.html#ref-vogelFlowDurationCurves1994" role="doc-biblioref">Vogel and Fennessey 1994</a>)</span>. For manual calculations, we typically calculate the exceedance probability as the rank value of a given flow divided by the the number of streamflow values plus 1 <span class="citation" data-cites="morrisonDevelopmentDurationCurveBased2008">(<a href="references.html#ref-morrisonDevelopmentDurationCurveBased2008" role="doc-biblioref">Morrison and Bonta 2008</a>)</span>:</p>
<p><span class="math display">\[
p_i = \frac{i}{n+1}
\]</span> where <span class="math inline">\(p_i\)</span> is the exceedance probability, <span class="math inline">\(i\)</span> is the rank number of a given streamflow and <span class="math inline">\(n\)</span> is the number of observations. <span class="math inline">\(p_i\)</span> is also called the Weibull plotting position which is the mean of the cumulative distribution function of the <span class="math inline">\(i\)</span>th observation <span class="citation" data-cites="gumbelStatisticsExtreme1958">(<a href="references.html#ref-gumbelStatisticsExtreme1958" role="doc-biblioref">Gumbel 1958</a>)</span>.</p>
<p>There are two methods for calculating this in <em>dplyr</em>. The first involves the direct calculation by ranking flows in descending order and dividing by length plus one. The second involves using the <code><a href="https://rdrr.io/r/stats/ppoints.html">ppoints()</a></code> function in R which returns ordered probability points for a given vector. by setting <code>a=0</code> we specify that the function returns the Weibull plotting positions.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Q_df</span> <span class="op">&lt;-</span> <span class="va">Q_df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">flow</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">flow</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## direct calculation if you prefer</span></span>
<span>    flow_exceedance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html">rank</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">flow</span><span class="op">)</span>, ties.method <span class="op">=</span> <span class="st">"last"</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">flow</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    <span class="co">## or weibull pp function, you don't need to do both!</span></span>
<span>    flow_exceedance_1 <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/ppoints.html">ppoints</a></span><span class="op">(</span><span class="va">flow</span>, a <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">Q_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">flow_exceedance</span>, <span class="va">flow</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://txwri.github.io/twriTemplates/reference/theme_TWRI_print.html">theme_TWRI_print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Daily Flow [cfs]"</span>, x <span class="op">=</span> <span class="st">"Proportion of Days Flow Exceeded"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-539a35d47e664c97a50115a146a7f1bd-1" class="quarto-figure quarto-figure-center anchored" width="1600">
<figure class="quarto-float quarto-float-fig figure"><div>
<img src="load-duration_files/figure-html/unnamed-chunk-3-1.png" id="fig-539a35d47e664c97a50115a146a7f1bd-1" class="img-fluid figure-img" width="1600">
</div>
</figure>
</div>
</div>
</div>
<p>The resulting FDC shows us the percent of time over the <em>entire period of record</em> that mean daily streamflows were exceeded. For example the above figure shows the max streamflow was around 10,000 cfs and the minimum was less than 1. Also 80% of the time, streamflows exceeded about 10 cfs.</p>
</section><section id="load-duration-curve" class="level3" data-number="7.2.2"><h3 data-number="7.2.2" class="anchored" data-anchor-id="load-duration-curve">
<span class="header-section-number">7.2.2</span> Load Duration Curve</h3>
<p>Now the FDC can be converted to an LDC by multiplying the mean daily streamflow volume by the allowable bacteria concentration. The general steps in your head should be:</p>
<ul>
<li>convert mean daily discharge (cfs) to daily volume for water (cubic feet, mL, whatever);</li>
<li>multiply the measured pollutant concentration by the daily volume</li>
</ul>
<p>This results in total mass or counts of pollutant per day.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Q_df</span> <span class="op">&lt;-</span> <span class="va">Q_df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># We don't need both flow exceedance columns</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">flow_exceedance_1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># MPN/100mL * cubic feet/sec * mL/cubic feet * sec/day = mpn/day</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ldc <span class="op">=</span> <span class="op">(</span><span class="fl">126</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span> <span class="op">*</span> <span class="va">flow</span> <span class="op">*</span> <span class="fl">28316.8</span> <span class="op">*</span> <span class="fl">86400</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">Q_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">flow_exceedance</span>, <span class="va">ldc</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://txwri.github.io/twriTemplates/reference/theme_TWRI_print.html">theme_TWRI_print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"*E. coli* [MPN/day]"</span>, x <span class="op">=</span> <span class="st">"Proportion of Days Load Exceeded"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-539a35d47e664c97a50115a146a7f1bd-2" class="quarto-figure quarto-figure-center anchored" width="1600">
<figure class="quarto-float quarto-float-fig figure"><div>
<img src="load-duration_files/figure-html/unnamed-chunk-4-1.png" id="fig-539a35d47e664c97a50115a146a7f1bd-2" class="img-fluid figure-img" width="1600">
</div>
</figure>
</div>
</div>
</div>
<p>The LDC looks exactly the same as the FDC, the units on the y-axis change to pollutant load per day. The next step is to add the measured concentrations to the figure. We need to join the bacteria data to the flow data, then calculate the measured loads. In order to plot this and label the legends properly, we need to manually set some of the aesthtic values in <code>ggplot2()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ecoli_df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">station_id</span>, <span class="va">end_date</span>, <span class="va">parameter_code</span>, <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Q_df</span> <span class="op">&lt;-</span> <span class="va">Q_df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">ecoli_df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span> <span class="op">=</span> <span class="st">"end_date"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>measured_load <span class="op">=</span> <span class="op">(</span><span class="va">value</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span> <span class="op">*</span> <span class="va">flow</span> <span class="op">*</span> <span class="fl">28316.8</span> <span class="op">*</span> <span class="fl">86400</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">Q_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">flow_exceedance</span>, <span class="va">ldc</span>,</span>
<span>                linetype <span class="op">=</span> <span class="st">"Allowable Load at Geomean Criterion (126 MPN/100 mL)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">flow_exceedance</span>, <span class="va">measured_load</span>,</span>
<span>                 shape <span class="op">=</span> <span class="st">"Measurement Value (MPN/day)"</span>,</span>
<span>                 color <span class="op">=</span> <span class="st">"Measurement Value (MPN/day)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_shape_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"values"</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">21</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"values"</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dodgerblue4"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://txwri.github.io/twriTemplates/reference/theme_TWRI_print.html">theme_TWRI_print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"*E. coli* [MPN/day]"</span>, x <span class="op">=</span> <span class="st">"Proportion of Days Load Exceeded"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.direction <span class="op">=</span> <span class="st">"vertical"</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-539a35d47e664c97a50115a146a7f1bd-3" class="quarto-figure quarto-figure-center anchored" width="1600">
<figure class="quarto-float quarto-float-fig figure"><div>
<img src="load-duration_files/figure-html/unnamed-chunk-5-1.png" id="fig-539a35d47e664c97a50115a146a7f1bd-3" class="img-fluid figure-img" width="1600">
</div>
</figure>
</div>
</div>
</div>
<p>We can already see general trends in the LDC and bacteria data. There is clearly a higher variance and probably a higher difference in median measured load and allowable load at high flows. As flows decrease (on the right hand side of the graph), a higher proportion of measured loads appear to be below the allowable load line.</p>
<p>There are several ways to quantify this. The easiest to explain to the general audience is to (1) split the flows into different regimes, (2) take the geomean of the loads within the flow regime, and (3) take the difference between geomean measured load and the median allowable load. Alternatively, we could fit a log-regression, LOADEST or generalized additive model to the data to estimate load across all exceedance percentiles. The former approach is shown below:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a summary table</span></span>
<span><span class="va">load_summary</span> <span class="op">&lt;-</span> <span class="va">Q_df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># classify flow conditions based on exceedance</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>flow_condition <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">flow_exceedance</span> <span class="op">&gt;=</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">flow_exceedance</span> <span class="op">&lt;</span> <span class="fl">0.1</span> <span class="op">~</span> <span class="st">"Highest Flows"</span>,</span>
<span>    <span class="va">flow_exceedance</span> <span class="op">&gt;=</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="va">flow_exceedance</span> <span class="op">&lt;</span> <span class="fl">0.4</span> <span class="op">~</span> <span class="st">"Moist Conditions"</span>,</span>
<span>    <span class="va">flow_exceedance</span> <span class="op">&gt;=</span> <span class="fl">0.4</span> <span class="op">&amp;</span> <span class="va">flow_exceedance</span> <span class="op">&lt;</span> <span class="fl">0.6</span> <span class="op">~</span> <span class="st">"Mid-range Conditions"</span>,</span>
<span>    <span class="va">flow_exceedance</span> <span class="op">&gt;=</span> <span class="fl">0.6</span> <span class="op">&amp;</span> <span class="va">flow_exceedance</span> <span class="op">&lt;</span> <span class="fl">0.9</span> <span class="op">~</span> <span class="st">"Dry Conditions"</span>,</span>
<span>    <span class="va">flow_exceedance</span> <span class="op">&gt;=</span> <span class="fl">0.9</span> <span class="op">&amp;</span> <span class="va">flow_exceedance</span> <span class="op">&lt;=</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Lowest Flows"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">flow_condition</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>median_flow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">flow</span>, <span class="fl">0.5</span>, type <span class="op">=</span> <span class="fl">5</span>, </span>
<span>                                   names <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            median_p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">flow_exceedance</span>, </span>
<span>                                      <span class="fl">.5</span>, type <span class="op">=</span> <span class="fl">5</span>, names <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                                      na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>            geomean_ecoli <span class="op">=</span> <span class="fu"><a href="https://andrisignorell.github.io/DescTools/reference/Gmean.html">Gmean</a></span><span class="op">(</span><span class="va">value</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            allowable_load <span class="op">=</span> <span class="va">median_flow</span> <span class="op">*</span> <span class="fl">126</span><span class="op">/</span><span class="fl">100</span> <span class="op">*</span> <span class="fl">28316.8</span> <span class="op">*</span> <span class="fl">86400</span>,</span>
<span>            geomean_load <span class="op">=</span> <span class="va">median_flow</span> <span class="op">*</span> <span class="va">geomean_ecoli</span><span class="op">/</span><span class="fl">100</span> <span class="op">*</span> <span class="fl">28316.8</span> <span class="op">*</span> <span class="fl">86400</span>,</span>
<span>            reduction_needed <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>              <span class="va">allowable_load</span> <span class="op">&lt;</span> <span class="va">geomean_load</span> <span class="op">~</span> <span class="va">geomean_load</span> <span class="op">-</span> <span class="va">allowable_load</span>,</span>
<span>              <span class="va">allowable_load</span> <span class="op">&gt;=</span> <span class="va">geomean_load</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>            percent_reduction_needed <span class="op">=</span> <span class="va">reduction_needed</span><span class="op">/</span><span class="va">geomean_load</span> <span class="op">*</span><span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">median_p</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>flow_condition <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor</a></span><span class="op">(</span><span class="va">flow_condition</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span></span>
<span><span class="va">load_summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  flow_condition  median_flow median_p geomean_ecoli allowable_load geomean_load
  &lt;fct&gt;                 &lt;dbl&gt;    &lt;dbl&gt;         &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;
1 Highest Flows         541       0.05         459.         1.67e12      6.07e12
2 Moist Conditio…        40.7     0.25         205.         1.25e11      2.04e11
3 Mid-range Cond…        19.7     0.5           95.8        6.07e10      4.62e10
4 Dry Conditions         12.6     0.75          68.3        3.88e10      2.10e10
5 Lowest Flows            6.9     0.95         103.         2.13e10      1.74e10
# ℹ 2 more variables: reduction_needed &lt;dbl&gt;, percent_reduction_needed &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Now we have some summary data that includes median values for each flow regime and estimates of required reductions. The next step is to add some info to the ggplot.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># set the y-axis value for the flow-regime labels</span></span>
<span><span class="va">label_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">Q_df</span><span class="op">$</span><span class="va">measured_load</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">Q_df</span><span class="op">$</span><span class="va">measured_load</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">Q_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## add some lines to indicate flow regimes</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.10</span>, <span class="fl">.40</span>, <span class="fl">.60</span>, <span class="fl">.90</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#cccccc"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## add ldc line</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">flow_exceedance</span>, <span class="va">ldc</span>,</span>
<span>                linetype <span class="op">=</span> <span class="st">"Allowable Load at Geomean Criterion (126 MPN/100 mL)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## add measured loads</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">flow_exceedance</span>, <span class="va">measured_load</span>,</span>
<span>                 shape <span class="op">=</span> <span class="st">"Measurement Value (MPN/day)"</span>,</span>
<span>                 color <span class="op">=</span> <span class="st">"Measurement Value (MPN/day)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## add summarized measured loads</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">load_summary</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">median_p</span>, <span class="va">geomean_load</span>,</span>
<span>                                      shape <span class="op">=</span> <span class="st">"Exisiting Geomean Load (MPN/day)"</span>,</span>
<span>                                      color <span class="op">=</span> <span class="st">"Exisiting Geomean Load (MPN/day)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## log10 y-axis</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## shrink the ends of the x-axis a little bit</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.005</span>,<span class="fl">0.005</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## manually set the shapes for the point aesthetics</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_shape_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"values"</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">21</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## manually set the shapes for the color aesthetic</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"values"</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"dodgerblue4"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## I like this tick marks that indicate a log transformed scale</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotation_logticks.html">annotation_logticks</a></span><span class="op">(</span>sides <span class="op">=</span> <span class="st">"l"</span>, color <span class="op">=</span> <span class="st">"#cccccc"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## add some labels to the flow-regimes</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">.05</span>, y <span class="op">=</span> <span class="va">label_max</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"High\nflows"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">3</span>, </span>
<span>           family <span class="op">=</span> <span class="st">"OpenSansCondensed_TWRI"</span>, lineheight <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">.25</span>, y <span class="op">=</span> <span class="va">label_max</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Moist\nconditions"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">3</span>, </span>
<span>           family <span class="op">=</span> <span class="st">"OpenSansCondensed_TWRI"</span>, lineheight <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">.50</span>, y <span class="op">=</span> <span class="va">label_max</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Mid-range\nflows"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">3</span>, </span>
<span>           family <span class="op">=</span> <span class="st">"OpenSansCondensed_TWRI"</span>, lineheight <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">.75</span>, y <span class="op">=</span> <span class="va">label_max</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Dry\nconditions"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">3</span>, </span>
<span>           family <span class="op">=</span> <span class="st">"OpenSansCondensed_TWRI"</span>, lineheight <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">.95</span>, y <span class="op">=</span> <span class="va">label_max</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Low\nflows"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">3</span>, </span>
<span>           family <span class="op">=</span> <span class="st">"OpenSansCondensed_TWRI"</span>, lineheight <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## labels</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"*E. coli* [MPN/day]"</span>, x <span class="op">=</span> <span class="st">"Proportion of Days Load Exceeded"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## general theme</span></span>
<span>  <span class="fu"><a href="https://txwri.github.io/twriTemplates/reference/theme_TWRI_print.html">theme_TWRI_print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.direction <span class="op">=</span> <span class="st">"vertical"</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-539a35d47e664c97a50115a146a7f1bd-4" class="quarto-figure quarto-figure-center anchored" width="1600">
<figure class="quarto-float quarto-float-fig figure"><div>
<img src="load-duration_files/figure-html/unnamed-chunk-7-1.png" id="fig-539a35d47e664c97a50115a146a7f1bd-4" class="img-fluid figure-img" width="1600">
</div>
</figure>
</div>
</div>
</div>
</section></section><section id="ldc-package" class="level2" data-number="7.3"><h2 data-number="7.3" class="anchored" data-anchor-id="ldc-package">
<span class="header-section-number">7.3</span> ldc Package</h2>
<p>Some of the steps described above cna be skipped by using the <a href="https://txwri.github.io/ldc/"><em>ldc</em></a> package. The package includes functions for period of record LDCs and annualized LDCs which are not covered here. One important functionality introduced with the package is the use of <a href="https://github.com/r-quantities/units/"><em>units</em></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># install.packages("ldc", </span></span>
<span><span class="co">#                  repos = c(txwri = 'https://txwri.r-universe.dev', </span></span>
<span><span class="co">#                            CRAN = 'https://cloud.r-project.org'))</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/TxWRI/ldc">ldc</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-quantities.github.io/units/">units</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ldc uses the unit package to facilitate unit conversions</span></span>
<span><span class="co">## we need to make the cfu unit first, since it isn't included </span></span>
<span><span class="co">## in the units package</span></span>
<span><span class="fu"><a href="https://r-quantities.github.io/units/reference/install_unit.html">install_unit</a></span><span class="op">(</span><span class="st">"MPN"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## get a new clean dataframe with column of Date, flows, and E. coli</span></span>
<span><span class="va">Q_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dataRetrieval/man/readNWISdv.html">readNWISdv</a></span><span class="op">(</span>siteNumbers <span class="op">=</span> <span class="st">"08162600"</span>,</span>
<span>           startDate <span class="op">=</span> <span class="st">"2000-01-01"</span>,</span>
<span>           endDate <span class="op">=</span> <span class="st">"2020-12-31"</span>,</span>
<span>           parameterCd <span class="op">=</span> <span class="st">"00060"</span>,</span>
<span>           statCd <span class="op">=</span> <span class="st">"00003"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dataRetrieval/man/renameNWISColumns.html">renameNWISColumns</a></span><span class="op">(</span><span class="va">Q_df</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">ecoli_df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span> <span class="op">=</span> <span class="st">"end_date"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">## attach a unit to streamflow</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>flow <span class="op">=</span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">flow</span>, <span class="st">"ft^3/s"</span><span class="op">)</span>,</span>
<span>         value <span class="op">=</span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">value</span>, <span class="st">"MPN/100mL"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Q_df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 7,671
Columns: 8
$ agency_cd      &lt;chr&gt; "USGS", "USGS", "USGS", "USGS", "USGS", "USGS", "USGS",…
$ site_no        &lt;chr&gt; "08162600", "08162600", "08162600", "08162600", "081626…
$ date           &lt;date&gt; 2000-01-01, 2000-01-02, 2000-01-03, 2000-01-04, 2000-0…
$ flow           [ft^3/s] 0.84 [ft^3/s], 3.00 [ft^3/s], 3.40 [ft^3/s], 2.60 [f…
$ flow_cd        &lt;chr&gt; "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", …
$ station_id     &lt;fct&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ parameter_code &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ value          [MPN/100mL] NA [MPN/100mL], NA [MPN/100mL], NA [MPN/100mL], N…</code></pre>
</div>
</div>
<p>With the dataframe setup, the <code><a href="https://txwri.github.io/ldc/reference/calc_ldc.html">calc_ldc()</a></code> function will generate a exceedance probabilities and flow regime categories:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## specify the allowable concentration</span></span>
<span><span class="va">allowable_concentration</span> <span class="op">&lt;-</span> <span class="fl">126</span></span>
<span><span class="co">## set the units</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/units.html">units</a></span><span class="op">(</span><span class="va">allowable_concentration</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"MPN/100mL"</span></span>
<span></span>
<span><span class="va">df_ldc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://txwri.github.io/ldc/reference/calc_ldc.html">calc_ldc</a></span><span class="op">(</span><span class="va">Q_df</span>, </span>
<span>                   Q <span class="op">=</span> <span class="va">flow</span>, </span>
<span>                   C <span class="op">=</span> <span class="va">value</span>, </span>
<span>                   allowable_concentration <span class="op">=</span> <span class="va">allowable_concentration</span>,</span>
<span>                   breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.9</span>, <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">0.1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                   labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Highest Flows"</span>, </span>
<span>                              <span class="st">"Moist Conditions"</span>,</span>
<span>                              <span class="st">"Mid-range Flows"</span>,</span>
<span>                              <span class="st">"Dry Conditions"</span>,</span>
<span>                              <span class="st">"Low Flows"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df_ldc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,671 × 13
   agency_cd site_no  date          flow flow_cd station_id parameter_code value
   &lt;chr&gt;     &lt;chr&gt;    &lt;date&gt;     [ft^3/… &lt;chr&gt;   &lt;fct&gt;      &lt;chr&gt;          [MPN…
 1 USGS      08162600 2000-08-18    0.22 A       &lt;NA&gt;       &lt;NA&gt;              NA
 2 USGS      08162600 2000-03-07    0.42 A       &lt;NA&gt;       &lt;NA&gt;              NA
 3 USGS      08162600 2000-03-06    0.6  A       &lt;NA&gt;       &lt;NA&gt;              NA
 4 USGS      08162600 2000-08-22    0.75 A       &lt;NA&gt;       &lt;NA&gt;              NA
 5 USGS      08162600 2000-03-08    0.78 A       &lt;NA&gt;       &lt;NA&gt;              NA
 6 USGS      08162600 2000-08-17    0.78 A       &lt;NA&gt;       &lt;NA&gt;              NA
 7 USGS      08162600 2000-09-11    0.8  A       &lt;NA&gt;       &lt;NA&gt;              NA
 8 USGS      08162600 2000-01-01    0.84 A       &lt;NA&gt;       &lt;NA&gt;              NA
 9 USGS      08162600 2000-08-21    0.93 A       &lt;NA&gt;       &lt;NA&gt;              NA
10 USGS      08162600 2000-03-05    1    A       &lt;NA&gt;       &lt;NA&gt;              NA
# ℹ 7,661 more rows
# ℹ 5 more variables: Daily_Flow_Volume [100mL/d], Daily_Load [MPN/d],
#   Allowable_Daily_Load [MPN/d], P_Exceedance &lt;dbl&gt;, Flow_Category &lt;fct&gt;</code></pre>
</div>
</div>
<p>With the LDC information calculated, the summary table can be generated with <code><a href="https://txwri.github.io/ldc/reference/summ_ldc.html">summ_ldc()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://txwri.github.io/ldc/reference/summ_ldc.html">summ_ldc</a></span><span class="op">(</span><span class="va">df_ldc</span>, </span>
<span>                   Q <span class="op">=</span> <span class="va">flow</span>, </span>
<span>                   C <span class="op">=</span> <span class="va">value</span>, </span>
<span>                   Exceedance <span class="op">=</span> <span class="va">P_Exceedance</span>,</span>
<span>                   groups <span class="op">=</span> <span class="va">Flow_Category</span>,</span>
<span>                   method <span class="op">=</span> <span class="st">"geomean"</span><span class="op">)</span></span>
<span><span class="va">df_sum</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 6
  Flow_Category    Median_Flow Median_P   Geomean_C Median_Daily_Flow_Volume
  &lt;fct&gt;               [ft^3/s]    &lt;dbl&gt; [MPN/100mL]                [100mL/d]
1 Highest Flows          541     0.0501       459.              13235973701.
2 Moist Conditions        40.7   0.25         205.                995756247.
3 Mid-range Flows         19.7   0.5           95.8               481975382.
4 Dry Conditions          12.6   0.75          68.3               308268519.
5 Low Flows                6.9   0.950        103.                168813713.
# ℹ 1 more variable: Median_Flow_Load [MPN/d]</code></pre>
</div>
</div>
<p>With the summary table we can finally plot the LDC:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://txwri.github.io/ldc/reference/draw_ldc.html">draw_ldc</a></span><span class="op">(</span><span class="va">df_ldc</span>,</span>
<span>         <span class="va">df_sum</span>,</span>
<span>         label_nudge_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"*E. coli* [MPN/day]"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://txwri.github.io/twriTemplates/reference/theme_TWRI_print.html">theme_TWRI_print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.direction <span class="op">=</span> <span class="st">"vertical"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-539a35d47e664c97a50115a146a7f1bd-5" class="quarto-figure quarto-figure-center anchored" width="1600">
<figure class="quarto-float quarto-float-fig figure"><div>
<img src="load-duration_files/figure-html/unnamed-chunk-11-1.png" id="fig-539a35d47e664c97a50115a146a7f1bd-5" class="img-fluid figure-img" width="1600">
</div>
</figure>
</div>
</div>
</div>
<p>We get the same outputs as the manual method with far fewer functions and less change for copy/paste errors. Another advantage of using <em>ldc</em> is the ability to change units on the fly without digging into a formula.</p>
<p>For example, the summary table shows median daily flow volume as 100ml/day. That isn’t an inuitive unit. Let’s report in million gallons per day instead by using the <code><a href="https://r-quantities.github.io/units/reference/units.html">set_units()</a></code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_sum</span> <span class="op">&lt;-</span> <span class="va">df_sum</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Median_Daily_Flow_Volume <span class="op">=</span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">Median_Daily_Flow_Volume</span>,</span>
<span>                                              <span class="st">"1E6gallons/day"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_sum</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 6
  Flow_Category    Median_Flow Median_P   Geomean_C Median_Daily_Flow_Volume
  &lt;fct&gt;               [ft^3/s]    &lt;dbl&gt; [MPN/100mL]           [1E6gallons/d]
1 Highest Flows          541     0.0501       459.                    350.  
2 Moist Conditions        40.7   0.25         205.                     26.3 
3 Mid-range Flows         19.7   0.5           95.8                    12.7 
4 Dry Conditions          12.6   0.75          68.3                     8.14
5 Low Flows                6.9   0.950        103.                      4.46
# ℹ 1 more variable: Median_Flow_Load [MPN/d]</code></pre>
</div>
</div>
<p>Often we report bacteria loads as million or billion counts per day:</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_sum</span> <span class="op">&lt;-</span> <span class="va">df_sum</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Median_Flow_Load <span class="op">=</span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">Median_Flow_Load</span>,</span>
<span>                                      <span class="st">"1E9MPN/day"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_sum</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 6
  Flow_Category    Median_Flow Median_P   Geomean_C Median_Daily_Flow_Volume
  &lt;fct&gt;               [ft^3/s]    &lt;dbl&gt; [MPN/100mL]           [1E6gallons/d]
1 Highest Flows          541     0.0501       459.                    350.  
2 Moist Conditions        40.7   0.25         205.                     26.3 
3 Mid-range Flows         19.7   0.5           95.8                    12.7 
4 Dry Conditions          12.6   0.75          68.3                     8.14
5 Low Flows                6.9   0.950        103.                      4.46
# ℹ 1 more variable: Median_Flow_Load [1E9MPN/d]</code></pre>
</div>
</div>
<p>Update units in df_ldc also:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_ldc</span> <span class="op">&lt;-</span> <span class="va">df_ldc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Daily_Load <span class="op">=</span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">Daily_Load</span>, </span>
<span>                                <span class="st">"1E9MPN/day"</span><span class="op">)</span>,</span>
<span>         Allowable_Daily_Load <span class="op">=</span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">Allowable_Daily_Load</span>, </span>
<span>                                          <span class="st">"1E9MPN/day"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df_ldc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,671 × 13
   agency_cd site_no  date          flow flow_cd station_id parameter_code value
   &lt;chr&gt;     &lt;chr&gt;    &lt;date&gt;     [ft^3/… &lt;chr&gt;   &lt;fct&gt;      &lt;chr&gt;          [MPN…
 1 USGS      08162600 2000-08-18    0.22 A       &lt;NA&gt;       &lt;NA&gt;              NA
 2 USGS      08162600 2000-03-07    0.42 A       &lt;NA&gt;       &lt;NA&gt;              NA
 3 USGS      08162600 2000-03-06    0.6  A       &lt;NA&gt;       &lt;NA&gt;              NA
 4 USGS      08162600 2000-08-22    0.75 A       &lt;NA&gt;       &lt;NA&gt;              NA
 5 USGS      08162600 2000-03-08    0.78 A       &lt;NA&gt;       &lt;NA&gt;              NA
 6 USGS      08162600 2000-08-17    0.78 A       &lt;NA&gt;       &lt;NA&gt;              NA
 7 USGS      08162600 2000-09-11    0.8  A       &lt;NA&gt;       &lt;NA&gt;              NA
 8 USGS      08162600 2000-01-01    0.84 A       &lt;NA&gt;       &lt;NA&gt;              NA
 9 USGS      08162600 2000-08-21    0.93 A       &lt;NA&gt;       &lt;NA&gt;              NA
10 USGS      08162600 2000-03-05    1    A       &lt;NA&gt;       &lt;NA&gt;              NA
# ℹ 7,661 more rows
# ℹ 5 more variables: Daily_Flow_Volume [100mL/d], Daily_Load [1E9MPN/d],
#   Allowable_Daily_Load [1E9MPN/d], P_Exceedance &lt;dbl&gt;, Flow_Category &lt;fct&gt;</code></pre>
</div>
</div>
<p>Now the updated units can be plotted on the LDC again:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://txwri.github.io/ldc/reference/draw_ldc.html">draw_ldc</a></span><span class="op">(</span><span class="va">df_ldc</span>,</span>
<span>         <span class="va">df_sum</span>,</span>
<span>         label_nudge_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"*E. coli* [Billion MPN/day]"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## make our labels more reader friendly</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/comma.html">comma</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://txwri.github.io/twriTemplates/reference/theme_TWRI_print.html">theme_TWRI_print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.direction <span class="op">=</span> <span class="st">"vertical"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-539a35d47e664c97a50115a146a7f1bd-6" class="quarto-figure quarto-figure-center anchored" width="1600">
<figure class="quarto-float quarto-float-fig figure"><div>
<img src="load-duration_files/figure-html/unnamed-chunk-15-1.png" id="fig-539a35d47e664c97a50115a146a7f1bd-6" class="img-fluid figure-img" width="1600">
</div>
</figure>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-gumbelStatisticsExtreme1958" class="csl-entry" role="listitem">
Gumbel, E.J. 1958. Statistics of Extreme. New York: Columbia University Press.
</div>
<div id="ref-morrisonDevelopmentDurationCurveBased2008" class="csl-entry" role="listitem">
Morrison, M.A., and Bonta, J.V. 2008. Development of Duration-Curve Based Methods for Quantifying Variability and Change in Watershed Hydrology and Water Quality. EPA/600/R-08/065. U.S. Environmental Protection Agency. <a href="https://nepis.epa.gov/Exe/ZyPURL.cgi?Dockey=P1000VR4.txt">https://nepis.epa.gov/Exe/ZyPURL.cgi?Dockey=P1000VR4.txt</a>.
</div>
<div id="ref-u.s.environmentalprotectionagencyApproachUsingLoad2007" class="csl-entry" role="listitem">
U.S. Environmental Protection Agency. 2007. An Approach for Using Load Duration Curves in the Development of TMDLs. EPA 841-B-07-006. U.S. Environmental Protection Agency. <a href="https://nepis.epa.gov/Exe/ZyPURL.cgi?Dockey=P1008ZQA.txt">https://nepis.epa.gov/Exe/ZyPURL.cgi?Dockey=P1008ZQA.txt</a>.
</div>
<div id="ref-vogelFlowDurationCurves1994" class="csl-entry" role="listitem">
Vogel, R.M., and Fennessey, N.M. 1994. Flow‐Duration Curves. I: New Interpretation and Confidence Intervals. Journal of Water Resources Planning and Management 120 (4): 485–504. <a href="https://doi.org/10.1061/(ASCE)0733-9496(1994)120:4(485)">https://doi.org/10.1061/(ASCE)0733-9496(1994)120:4(485)</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        console.log("RESIZE");
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./water-quality.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Water Quality Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./water-quality-statistics.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Hypothesis Testing</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://twri.tamu.edu">Texas Water Resources Institute</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This work is licensed under <a href="http://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1">CC BY-NC 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" class="img-fluid" style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" class="img-fluid" style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"><img src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" class="img-fluid" style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"></a></p>
</div>
  </div>
</footer>


</body></html>